# AtCoder-heuristic-Contest048
## Contest time 5/30 19:00～6/9 19:00


## Question
# 🎨 高橋画伯の色彩チャレンジ（調色パズル問題）

## 概要

高橋画伯は新作の水彩画制作のために、**指定された色**をできるだけ**正確に**、かつ**無駄なく**調合したいと考えています。  
あなたはそのアシスタントとして、所持している複数のチューブ絵の具から目標の色を調合し、順番通りに画伯に渡す必要があります。

絵の具の無駄使いは減点対象になるため、**精度と節約の両立**が求められます。

---

## 問題設定

- 色は `(C, M, Y)` の **三次元ベクトル**（各成分 ∈ [0, 1]）で表現される。
- 絵の具は混ぜると **重み付き平均**の色になる。

例：  
- 赤 (1,0,0) を 4g、緑 (0,1,0) を 6g 混ぜると：  
  → 合計 10g、色は (0.4, 0.6, 0)

---

## パレット

- パレットは **N×Nのグリッド**。
- マスは**仕切りの出し入れ**によって連結・分離できる。
- **連結しているマス**の集合を「ウェル」と呼び、1色のみ保持可能。
- **マスの数 = 容量（g）**。3マスのウェルなら最大3gまで。

---

## 操作（最大 Tターン）

以下のいずれかを1ターンとして操作できる：

1. **チューブから追加**  
   - 絵の具チューブを1本選び、指定マスに **1gだけ追加**（超えた分は破棄）

2. **画伯に1g渡す**  
   - ウェルの絵の具から **1gちょうど**を取り出す  
   - 各色について **1g未満だと不可**（`v < 1 - 1e-6` はNG）

3. **廃棄**  
   - ウェルから **任意量**を捨てる

4. **仕切りの出し入れ**  
   - ウェルの分割 or 結合ができる  
   - 分割時は、色・量を面積比で分ける

---

## 調合すべき色

- 調合対象は **H色**。
- それぞれ **順番どおりに1gずつ** 渡す必要がある。
- 精度が重要（下記の誤差スコアに影響）。

---

## 得点計算

### 誤差スコア \( E \)

各提出色 \( (C_i, M_i, Y_i) \) と目標色 \( (C_i^*, M_i^*, Y_i^*) \) の二乗誤差：

```math
E = \sum_{i=0}^{H-1} \left[ (C_i^* - C_i)^2 + (M_i^* - M_i)^2 + (Y_i^* - Y_i)^2 \right]




## plan

### 5/30(1日目)
１．解法:２本混ぜ最もターゲットの色に近い色を作る
 * 1. 仕切りを全部下げて連結ウェルを1つにする
 * 2. 2本のチューブから色を混ぜて、ターゲットの色に最も近い色を作る

 絶対得点135,779,851、相対得点：3,369,391,521  パフォ1005 (5/31 0:29時点)

 2.解法　仕切り等を使っていないため使う
 =>仕切る方法で得点変わってくる？
 ＝＞どうやって仕切る？

 解法:２本混ぜ最もターゲットの色に近い色を作る
 * 1. 4マス正方形（2x2）のウェルを作る
 * 2. 2本のチューブから色を混ぜて、ターゲットの色に最も近い色を作る

 絶対得点166,336,640、相対得点：3,169,555,693  パフォ956 (5/31 0:29時点) 下がった

 ここで勘違い発覚　絶対得点は小さいほうがいい

 解法３：貪欲法使用する
 1つ目のターゲット色を適当に選び、以降は「現在の色に最も近い未使用のターゲット色」を順に選んで並べる。

#### 解法4：TSP順序最適化＋全仕切り下げ＋再利用
- 1. 仕切りを全て下げてパレット全体を1つの大ウェルにする  
- 2. ターゲット色の順序をTSP（巡回セールスマン問題）近似（Nearest Neighbor法＋2-opt）で最適化  
- 3. 直前に作った色が十分近ければ再利用し、操作回数・誤差を抑える  
- 4. 1本注ぎで十分近い場合は1本だけ注ぐ。どちらもダメなら2本混ぜで最適な比率を探索

絶対得点：135,295,432　相対得点：2,898,549,433　パフォ973（5/31時点2:30） 最高得点

**工夫ポイント**
- 色順序最適化で色移動距離を短縮
- 仕切りを使わず全体を大ウェル化し、色の再利用を最大化
- 2-opt法で色順序をさらに改善
- 1本注ぎ・既存色再利用で操作回数を削減
 
次から大ウェルから＝＞区切り付けて考える
問題を吟味して考える(方針　得点上げ方)
目標　相対得点50億！！


### 5/31(2日目)

#### 解法５(仕切り追加に混色に力入れる)
5×5のウェル（wellSize=4, N=20で25個）に分割し、
 * まず全てのウェルに色を1gずつ入れてから調整を始める。
 * 
 * 各ターゲット色ごとに：
 *   1. 全ウェルから最も近い色を探索し、1g以上あればそのまま渡す。
 *   2. 追加注ぎ（動作1）で近づく場合は追加して渡す。
 *   3. 動作4（隣接マス間の仕切りを外して混ぜる）で近づく場合は混ぜて渡す。
 *   4. それでもダメなら一番近いウェルを上書きして渡す。
 * 
 * 各ウェルのグラム数を管理し、1g未満の場合は渡せない・混ぜられないようにしている。
 * 動作4はマス単位で隣接判定し、正しく混合できるようにしている。

 絶対得点：63,232,152　相対得点：3,791,025,935　パフォ1404（5/31時点15:13） 

#### 解法6（混色＋追加注ぎ全探索）

5×5のウェル（wellSize=4, N=20で25個）に分割し、  
まず全てのウェルに色を1gずつ入れてから調整を始める。

各ターゲット色ごとに：
 1. 全ウェルから最も近い色を探索し、1g以上あればそのまま渡す。
 2. 追加注ぎ（動作1）で近づく場合は追加して渡す。
 3. 動作4（隣接マス間の仕切りを外して混ぜる）で近づく場合は混ぜて渡す。
 4. **さらに、混ぜた後に追加注ぎ（動作1）も全チューブで試し、より近づく場合はその操作を選ぶ。**
 5. それでもダメなら一番近いウェルを上書きして渡す。

各ウェルのグラム数を管理し、1g未満の場合は渡せない・混ぜられないようにしている。  
動作4はマス単位で隣接判定し、正しく混合できるようにしている。

**改善点**  
- 混ぜるだけでなく「混ぜてから追加注ぎ」も全チューブで試すことで、よりターゲット色に近い色を作れる場合を考慮。
- これにより、従来よりも誤差が小さくなるケースが増え、スコア向上が期待できる。

絶対得点：53,661,869　相対得点：2,886,143,049　パフォ1467（5/31時点19:25） 


**目標：絶対得点 25,000,000 を目指してさらに改善中！**


#### 仕切りの使い方

- パレット全体を5×5のウェル（wellSize=4, N=20で25個）に分割し、各ウェルごとに色を管理することで、色の混ざりを制御しやすくしている。
- 仕切り（動作4）は「隣接する2つのウェル間」でのみ外すことができ、混ぜたい時だけピンポイントで混色できる。
- これにより、不要な色の混ざりを防ぎつつ、必要な時だけ混色してターゲット色に近づけることができる。
- 仕切りを外す位置・タイミングを工夫することで、混色パターンの多様性と色の再利用効率を両立している。

#### 破棄する条件

- 各ウェルのグラム数が1g未満の場合、そのウェルの色は納品や混色に使えない（破棄扱い）。
- また、ターゲット色に対してどの操作（追加注ぎ・混色・混ぜて追加注ぎ）でも十分近づけない場合は、既存の色を「上書き」して新しい色を作る（実質的に破棄して再利用）。
- 今後の改善案として、「誤差が大きい色」や「今後使い道がなさそうな色」を積極的に破棄・上書きする戦略を導入することで、より効率的な色管理ができる可能性がある。

#### 解法７

## 全体の流れ

1. **パレットの仕切りを出力し、5×5のウェル構造を作る。**
2. **各ウェルにチューブ色を順番に1gずつ入れる（初期化）。**
3. **各ターゲット色ごとに、以下の操作を最適な組み合わせで選択し納品する：**
    - そのまま納品（既存ウェルの色が近い場合）
    - 追加注ぎ（既存ウェルにチューブ色を加えて混ぜる）
    - 混合（隣接する2つのウェルを混ぜる）
    - 混合＋追加注ぎ（混合後さらにチューブ色を加えて混ぜる）
    - 使えるウェルがない場合は空きウェルに新たに色を追加

---

## 工夫点

- 納品・追加注ぎ・混合・混合＋追加注ぎの**全組み合わせを全探索**し、ターゲット色に最も近づく操作を選択します。
- 各ウェルの色（RGB）と残量（グラム数）を管理し、**1g未満のウェルは使わない**ようにしています。
- 混合は**マス単位で隣接判定**し、正しく混ぜられるようにしています。
- 納品後や混合後のウェルの状態も**正しく更新**します。

---

## 注意点

- 動作1: 色を追加（追加注ぎ）、動作2: 納品、動作4: 混合（仕切りを外して混ぜる）を出力します。
- 動作3（破棄）は本実装では使用していません。
- 最大ターン数TやコストDは本実装では未使用です。

---

### スコア

- 絶対得点：52,890,065
- 相対得点：2,260,549,098
- パフォ1439（6/1時点0:00）

---

#### 解法８

**全ての納品・追加注ぎ・混合・混合＋追加注ぎの全組み合わせを全探索**し、ターゲット色に最も近い操作を必ず選択する。
    - 追加注ぎは「全ウェル×全チューブ」、
    - 混合・混合＋追加注ぎは「全ウェルペア×全隣接マス×全チューブ」を全て試す。
- 各ウェルの色（RGB）と残量（グラム数）を厳密に管理し、1g未満のウェルは使わない。
- 混合はマス単位で隣接判定し、正しく混ぜられるようにしている。
- 納品後や混合後のウェルの状態も正しく更新。
- 既存ウェルや混合で十分近い色が作れない場合は、**空きウェルに最も近いチューブ色を新規投入して納品**する。
- 使い回しペナルティ（同じウェルの連続利用や使用回数）も考慮し、色の偏りを防ぐ。
- 動作3（破棄）は現状未使用だが、今後の改善余地あり。
- **従来よりも圧倒的に多くの組み合わせを探索することで、色の精度・柔軟性が大幅に向上**している。

### スコア

- 絶対得点：22,811,033	(目標達成！！)
- 相対得点：5,186,245,852 
- パフォ1963（6/1時点3:00）
- 現状84位

### 6/1(３日目)

相対得点：5,082,960,005
- パフォ1916（6/1時点14:00）



#### 解法9

構想

仕切りの動作は仕切りを出すときと変わらず隣接している
ウェルと仕切りの出し入れを可能とするが
仕切りを出した場所を保存しとかないと多分区別できないから
仕切り出したところを理解しといて、
仕切りを入れる際それを利用する

分割後(仕切りを入れた後)、隣接するマスと新たな混合ができて
色の精度を上げれる可能性があるため、一度その周りを確かめる


分割後の混合や追加注ぎの遷移を探索に入れる部分は正しいですが、実際の分割（仕切り操作）や分割後のウェル管理が実装されていないため、
opType==7～10の実行部で「どのウェルをどう使うか」「どの位置で混合するか」などが未定義のままになっています。

主な問題点
分割後のウェル（仮想的なS側/T側）の位置や容量管理がされていない
→ 実際には「分割して新しいウェルを作る」必要があるが、今は元のウェル1つしか管理していない
mixX1, mixY1, mixX2, mixY2などの座標が分割遷移で正しく設定されていない
実行部で「分割→混合→納品」などの一連の操作が現実の盤面に反映されていない

まとめ
分割後のS側/T側を新しいウェルとして管理し直す必要があります
その上で「混合・追加注ぎ・納品」などの操作を現実の盤面に沿って出力・管理してください
今のままでは「仮想的な分割」だけで、実際の盤面遷移が伴っていません
アドバイス
まずは「分割したら空きウェルにS側を移す」ロジックを追加し、
その後で混合や追加注ぎの探索・実行を行う形に整理しましょう
盤面管理が複雑になるので、一度に多くの遷移を詰め込まず、分割→混合→納品の流れを1つずつ丁寧に実装するのがおすすめです



成果なし

スコアを上げるための改善案はいくつかあります。
現状の全探索＋最小色差選択は「それなり」ですが、さらに伸ばすには以下の工夫が有効です。

1. ウェルの再利用・リセット戦略
使い終わったウェルを積極的に「リセット」して再利用（例えば、1g未満になったら破棄→新色投入）
混合や追加注ぎで色が濁ったウェルは早めに空ける
2. ターゲット色のクラスタリング
ターゲット色を事前にクラスタリングし、似た色を同じウェルで処理する
例えばK-meansや単純なグリッド分割でクラスタを作り、各クラスタごとにウェルを割り当てる
3. 混合の優先度・探索幅の拡大
混合候補を「色差が近いもの同士」に限定し、無駄な混合を減らす
追加注ぎや混合＋追加注ぎの「注ぐ量」を1g以外も試す（例：2g, 3gなど）
4. 操作の順序最適化
納品順を「近い色から順に」や「同じウェルで連続納品できる順に」並べ替える
これによりウェルの色変化を最小限に抑えられる
5. ビームサーチ・焼きなまし・貪欲＋局所探索
ビームサーチや焼きなまし法で納品順や操作列を最適化
局所探索で「一手戻して別の操作を試す」などの微調整を加える
6. パラメータチューニング
ペナルティやウェル使用回数の重みを調整（現状は0.01 * wellUsed[w]など）
混合・追加注ぎの閾値や優先度を調整
7. 並列化・マルチスレッド
全探索部分を並列化し、より多くの候補を高速に評価



#### 解法10

１つのウェル数を４＝＞３にする


### スコア

- 絶対得点：20,863,263　(-200万！)
- 相対得点：4,867,176,157
- パフォ1840（6/2時点18:00）
- 現状163位 => 現状143位

## ここまで基本的な貪欲法で１色ずつ作ってる。


## ここから局所探索を追加する

####　解法11
局所探索の実装を完全に削除し、基本的な操作に戻した。
主な変更点

局所探索のコードを完全に削除
操作の履歴管理を削除
候補の保持とソートを削除
基本的な4つの操作（そのまま納品、追加注ぎ、混合、混合＋追加注ぎ）に集中

### スコア

- 絶対得点：20,401,244	　(-40万！)
- 相対得点：4,968,925,798
- パフォ1823（6/2時点20:30）
- 現状150位 => 現状148位

#### 解法１２

簡潔なコードに戻し、上手くウェルを循環するようにペナルティ+0.01した。
1. 基本的な操作の最適化
 *    - そのまま納品：使用回数の重み付けで均等使用を促進
 *    - 追加注ぎ：容量チェックを厳密に行い、重み付き平均で色を計算
 *    - 混合：隣接するウェルのみを考慮し、効率的な混合を実現
 *    - 混合＋追加注ぎ：混合後の色をさらに改善
 * 
 * 2. ウェル使用の効率化
 *    - 空きウェルの積極的な活用
 *    - 使用回数に基づくペナルティで均等使用を促進
 *    - 前回使用したウェルへのペナルティで多様な使用を促進
 * 
 * 3. 安定性の確保
 *    - 1グラム未満のウェルは使用不可
 *    - 容量オーバーを防ぐ厳密なチェック
 *    - フォールバック処理で必ず操作を実行

 ### スコア

- 絶対得点：20,327,557	　(-8万！)
- 相対得点：4,850,564,440
- パフォ1827（6/2時点22:13）
- 現状150位 => 現状147位


現状164位(6/3時点)
パフォ1788

限界を感じてる


6/5(六日目)

